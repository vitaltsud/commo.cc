# План развёртывания commo.cc

Сервер: **84.247.164.76** (Kontabo). Существующие системы не менять — только добавлять сервисы и конфиги.

---

## Деплой по команде (скрипты)

Деплой настроен так же, как в проекте **app.crmca.cc**: используются те же SSH-ключи (доступ по ключам уже настроен для этого хоста).

На своей машине:

1. Скопировать `.env.deploy.example` в `.env.deploy`, указать `COMMO_SSH` (например `root@84.247.164.76`) и `COMMO_REMOTE_PATH` (путь к клону репо на сервере). Ключ можно не указывать — используется тот же, что и для crmca.cc.
2. Один раз на сервере: клонировать репо в `COMMO_REMOTE_PATH`, настроить PM2 или systemd (см. фазы ниже).
3. Дальше для выката: запускать **`./scripts/deploy.sh`** (Git Bash / WSL) или **`powershell -File scripts/deploy.ps1`** (PowerShell). Скрипт по SSH зайдёт на сервер и выполнит `git pull`, `npm ci`, `npm run build`, перезапуск приложения.

---

## Фаза 0: Подготовка (без изменений на сервере)

1. **Репо и окружение**
   - Клонировать репозиторий в каталог деплоя (например `~/commo` или `/var/repos/commo.cc`).
   - Локально: проверить сборку Next.js и тесты.

2. **Документация сервера**
   - [docs/server/README.md](../server/README.md) — хост, SSH по ключам.
   - [docs/server/domains.md](../server/domains.md) — добавление доменов commo.cc / adm.commo.cc.

3. **Переменные окружения**
   - Подготовить шаблон `.env.production`: Google OAuth, API ключи, БД, URL приложения и админки.

---

## Фаза 1: Разведка на сервере (только чтение)

По SSH (по ключам):

1. Узнать ОС и веб-сервер:
   - `cat /etc/os-release`
   - `which nginx apache2`; `systemctl list-units --type=service | grep -E 'nginx|apache'`
2. Посмотреть текущие сайты:
   - `ls /etc/nginx/sites-enabled/` или `ls /etc/apache2/sites-enabled/`
3. Проверить порты и занятость:
   - `ss -tlnp | grep -E ':80|:443|:3000'`
4. Проверить, есть ли Node/npm/PM2:
   - `node -v`, `npm -v`, `pm2 -v` (если используется).

Ничего не менять — только зафиксировать в заметках.

---

## Фаза 2: Домены и веб-сервер

1. **DNS** (у регистратора commo.cc):
   - A: `commo.cc`, `www.commo.cc`, `adm.commo.cc` → `84.247.164.76`.

2. **Новый vhost** (не трогать существующие):
   - Nginx: скопировать [nginx-commo.example.conf](../server/nginx-commo.example.conf) в `sites-available/commo.cc`, включить через `sites-enabled`, поправить пути при необходимости.
   - Apache: аналогично [apache-commo.example.conf](../server/apache-commo.example.conf).
   - Сначала указать `root` на заглушку (например пустая страница в `/var/www/commo.cc/current/public`), проверить открытие по домену.

3. **Проверка и перезагрузка:**
   - `nginx -t` или `apache2ctl configtest` → затем `systemctl reload nginx` или `reload apache2`.

4. **SSL:** после успешного HTTP — `certbot --nginx` (или `--apache`) только для `commo.cc`, `www.commo.cc`, `adm.commo.cc`.

---

## Фаза 3: Окружение приложения

1. **Node.js** (если ещё нет):
   - Установить LTS (nvm или пакетом), не трогать системный Python/другие runtime, если они используются другими проектами.

2. **Каталоги** (без перезаписи чужих):
   - `/var/www/commo.cc/` — основное приложение (или выбранный путь).
   - `/var/www/adm.commo.cc/` — админка (если отдельный деплой).
   - Права: пользователь деплоя + веб-сервер на чтение статики.

3. **Переменные окружения:**
   - Создать `.env.production` в корне приложения (или в домашней директории пользователя деплоя), не коммитить.

4. **БД и бэкапы:**
   - Если БД уже есть на сервере — не переустанавливать, только создать нового пользователя/базу для commo.cc.
   - Настроить бэкапы только для новой БД/таблиц.

---

## Фаза 4: Сборка и запуск приложения

1. **Установка зависимостей и сборка:**
   - В каталоге приложения: `npm ci`, `npm run build` (или `pnpm build`).
   - Для админки — отдельная сборка в свой каталог, если отдельный репо/подпроект.

2. **Запуск:**
   - Вариант A: **PM2** — отдельный ecosystem-файл для commo.cc (и при необходимости для adm), порты не конфликтуют с существующими сервисами (например 3000 и 3001).
   - Вариант B: systemd unit для Node — отдельный сервис `commo.cc.service`.
   - Порт приложения (например 3000) не открывать наружу — только проксировать через nginx/apache.

3. **Прокси в vhost:**
   - В nginx/apache для `commo.cc` заменить `root` на `proxy_pass http://127.0.0.1:3000` (и при необходимости WebSocket).
   - Для `adm.commo.cc` — `proxy_pass http://127.0.0.1:3001` (или выбранный порт).
   - Снова `nginx -t` / `apache2ctl configtest` и reload.

4. **Проверка:**
   - Открыть https://commo.cc и https://adm.commo.cc в браузере, проверить редиректы и логи.

---

## Фаза 5: Пост-деплой

1. **Мониторинг и логи:**
   - Настроить ротацию логов приложения и веб-сервера (logrotate), не трогать настройки логов других сайтов.

2. **CI/CD (опционально):**
   - Скрипт деплоя: pull → npm ci → build → перезапуск PM2/systemd только для commo.cc/adm.

3. **Бэкапы:**
   - Расписание бэкапов БД и при необходимости критичных конфигов (только добавленные для commo.cc).

---

## Краткий чеклист

| Шаг | Действие | Не ломаем |
|-----|----------|-----------|
| 0 | Репо, .env, документация | — |
| 1 | Разведка: ОС, веб-сервер, порты, сайты | Только чтение |
| 2 | DNS, новый vhost, SSL для commo.cc / adm | Не трогать другие vhost |
| 3 | Node, каталоги, .env, БД для commo | Не менять чужие сервисы/БД |
| 4 | build, PM2/systemd, proxy в nginx/apache | Отдельные порты и юниты |
| 5 | Логи, деплой-скрипт, бэкапы | Только новые конфиги |

---

## Контакты и доступ

- **SSH:** по ключам на `84.247.164.76` (пользователь — из панели Kontabo или текущий админ).
- При проблемах: откат = отключить только новый vhost и остановить приложение commo.cc; остальные системы не трогать.
