# Правила проекта commo.cc

Документ фиксирует правила, по которым ведётся разработка и работа ассистента в репозитории.

---

## 1. Роль ассистента

- **Ассистент сам всё делает:** код, конфиги, скрипты, документация, трассировка, деплой.
- **Пользователь только даёт указания** — не ждать, что он будет править код или писать команды сам.
- **Сервер:** SSH (ключи и хост в `.env.deploy`). Ассистент:
  - запускает деплой: `scripts/deploy.ps1` или `./scripts/deploy.sh`;
  - при необходимости — трассировку на сервере, правки nginx/PM2 через SSH;
  - готовит скрипты и конфиги в репо, чтобы на сервере всё работало по одной команде.
- Не отвечать «сделай сам» или «запусти у себя» — делать максимум сам.
- **Деплой всегда сам и сразу:** после любых изменений кода или конфигов, влияющих на сайт, сам выполнять `git add` → `commit` → `push` и затем деплой. Не предлагать «теперь задеплой» — делать деплой в том же цикле работы.

---

## 2. Переводы и локали

- **В коде:** только английские ключи через `t("section.key")`. Без хардкода UI-строк.
- **Эталон:** `messages/en.json` — все ключи и значения на **английском**. Новые фразы сначала добавлять в en.json.
- **Локали:** русский, польский, украинский, немецкий, испанский, итальянский и др. — в `messages/ru.json`, `messages/pl.json`, `messages/uk.json`, `messages/de.json`, `messages/es.json`, `messages/it.json`. В коде и в en.json русского/локального текста не писать.
- **Workflow:** при добавлении/изменении текста: (1) ключ и английский текст в **en.json**; (2) перевод в **ru.json** (и при необходимости в pl, uk); (3) в шаблоне — только `t("key")` или `t("key", { count, ... })`.
- **Plural:** ключ-объект с формами `one`, `few`, `many`, `other` в JSON; в коде — `t("key", { count: n })`.

Подробнее: `docs/translation-system.md`, `docs/localization.md`.

---

## 3. Контекст продукта (vision, стек, логика)

- **Продукт:** глобальный сервисный маркетплейс (клиенты ↔ мастера). «Hard Trust»: верификация по ID обязательна только для мастеров; рейтинги от клиентов неизменяемые. Один аккаунт может быть и заказчиком, и мастером; интерфейсы разделены («Мои проекты» vs «Как мастер»). Монетизация — подписка для мастеров (без комиссий с сделок). Экосистема Google: Auth, Chat, AI-аналитика.
- **Стек:** Next.js (App Router), Tailwind, Framer Motion, Google OAuth. Шрифт Inter. Дизайн: минимализм, контраст (белый / Graphite `#1A1A1A`), mobile-first.
- **Навигация:** логотип; ссылки «Проекты», «Мастера» (ведут на главную к спискам); «How it Works», «For Pros»; выбор города, языка; «Sign in». После входа в меню пользователя: «My Projects», «As master», «Settings», «Sign out». Админка — `adm.commo.cc`.
- **UI:** Inter, лёгкие анимации (framer-motion), акцент `#2563EB`. Мобильная навигация — удобная для большого пальца.
- **Логика приложения (роли, верификация, поиск, сессия):** `docs/logic.md` — единый документ логики; поддерживать актуальным при изменениях.

---

## 4. URL и SEO

- **Формат:** сначала GEO (страна), затем язык. `/страна/` — дефолтный язык; `/страна/язык/` — для недефолтных.
- Подробно: `docs/urls-and-seo.md`.

---

## 5. Документация

- Оглавление: `docs/README.md`.
- Сервер, домены, деплой: `docs/server/`, `docs/deployment/plan.md`.
- Локализация, переводы, URL/SEO: см. ссылки выше.

Исходники правил для Cursor: `.cursor/rules/` (agent-does-everything.mdc, translation-locale.mdc, commo-system.mdc, security.mdc).

---

## 6. Безопасность

- **Заголовки:** X-Frame-Options: DENY, X-Content-Type-Options: nosniff, Referrer-Policy: strict-origin-when-cross-origin, Permissions-Policy — заданы в `next.config.mjs` для всех ответов.
- **Редиректы:** только относительные пути без `:`. В callback/signin проверка `isValidCallbackUrl` (startsWith("/") && !includes(":")) — защита от open redirect.
- **Инъекции:** все запросы к БД через Drizzle ORM (параметризованные запросы). Запрещены сырые SQL со строковой конкатенацией пользовательского ввода.
- **Ввод из API/форм:** параметры country, category, city — только из белых списков: `getCountryByCode`, `isValidCategorySlug`, `isCitySlug`. В server actions (setCountry, setLocale, setCity) то же самое.
- **Сессия:** cookie httpOnly, secure в production, sameSite: lax. Подпись HMAC-SHA256; в production обязателен SESSION_SECRET (или CRYPTO_SECRET) не короче 16 символов. Сравнение подписей через timingSafeEqual.
- **XSS:** в HTML не вставлять сырой пользовательский ввод. `dangerouslySetInnerHTML` — только для сгенерированного на сервере JSON-LD (JSON.stringify наших данных), без подстановки пользовательских данных в строку.
- **Секреты:** GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, SESSION_SECRET — только в env, не в коде. В production не использовать fallback-секрет из кода.
