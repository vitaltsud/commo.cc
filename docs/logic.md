# Логика приложения commo.cc

Документ описывает бизнес-логику и правила, по которым работает приложение. Обновляется при изменении логики (роли, авторизация, верификация, поиск, SEO и т.д.).

---

## 1. Роли и один аккаунт

- **Один аккаунт = один пользователь в БД.** Пользователь может быть и **заказчиком (клиентом)**, и **мастером** в рамках одного логина.
- **Интерфейсы разделены жёстко:**
  - **Клиент:** «Мои проекты» (`/my-projects`) — публикация и управление проектами. Доступ без верификации.
  - **Мастер:** «Как мастер» / кабинет мастера (`/pro`) — заявки, профиль мастера, подписка. Доступ к кабинету и появлению в выдаче только после верификации.
- В навигации после входа: в меню пользователя отдельно «Мои проекты» и «Как мастер»; разделы не смешиваются.

---

## 2. Верификация

- **Клиент (публикация проектов):** верификация **не требуется**. Любой залогиненный пользователь может создавать проекты.
- **Мастер (работа как исполнитель):** верификация **обязательна**. Пользователь должен пройти верификацию (ID), чтобы:
  - получить/активировать профиль мастера (`pro_profile`);
  - отображаться в выдаче по категориям и городам;
  - пользоваться кабинетом мастера в полном объёме.
- В БД: у мастера признак `pro_profiles.verified = true`. В поиске и на главной показываются только верифицированные мастера.

---

## 3. Рейтинги

- **Рейтинги раздельные по ролям:**
  - **Рейтинг мастера** — в `pro_profiles.rating`; выставляют заказчики после сделки. Отдельная сущность от рейтинга как заказчика.
  - **Рейтинг как заказчик** — в `users.client_rating`; могут выставлять мастера (логика подсчёта и отображения — при необходимости позже).
- В интерфейсе и в API не смешивать рейтинг «как мастер» и «как заказчик».

---

## 4. Авторизация и сессия

- **Вход:** только через Google OAuth («Sign in with Google»). Логин/пароль не используются.
- **После успешного входа:** обмен code на токен, запрос данных пользователя у Google; в БД ищется или создаётся запись в `users` по `google_id` или `email`. В cookie записывается сессия с `userId` (id в нашей БД), имя, email, картинка.
- **Сессия:** подписанная cookie (`commo_session`), в payload — `userId`, id Google, name, email, picture. Срок жизни — 30 дней. Секрет: `SESSION_SECRET` или `CRYPTO_SECRET` в env.
- **Возврат после входа:** при переходе на «Sign in» сохраняется текущая страница в `callbackUrl` (query → state в OAuth); после callback редирект на эту страницу. Валидация: только относительные пути, без протокола (защита от open redirect).

**Файлы:** `lib/session.ts`, `app/api/auth/callback/google/route.ts`, `app/api/auth/session/route.ts`, `app/api/auth/signout/route.ts`.

---

## 5. Определение ролей в приложении

- **Клиент:** любой залогиненный пользователь. Возможность публиковать проекты не зависит от наличия профиля мастера.
- **Мастер (есть профиль):** у пользователя есть хотя бы одна запись в `pro_profiles` (без требования verified для «есть кабинет», но для выдачи в поиске — только verified).
- **Верифицированный мастер:** хотя бы один `pro_profile` с `verified = true`.

API сессии возвращает: `user` (userId, name, email, picture) и `roles: { client: true, pro: boolean, proVerified: boolean }`. Логика: `client` всегда true для залогиненных; `pro` — есть ли pro_profiles; `proVerified` — есть ли хотя бы один verified.

---

## 6. Поиск и выдача

- **Проекты по категории/городу:** `loadProjectsByCategory(country, category, city?)`. Фильтр: страна, категория, опционально город. Ограничение по роли заказчика не накладывается (любой пользователь мог создать проект).
- **Мастера по категории/городу:** `loadProsByCategory(country, category, city?)`. В выборку попадают **только верифицированные** мастера (`pro_profiles.verified = true`), по стране, категории и опционально городу (через `pro_profile_cities`). Поле `users.role` в фильтрации не используется.
- **Главная страница:** две колонки — «Проекты» (все проекты страны или выбранного города) и «Мастера» (все верифицированные мастера страны или города). Ниже — блок преимуществ, сетка категорий, блок «по региону и категории», фиды последних заказов и мастеров. При выбранном городе (URL или x-city) списки в колонках фильтруются по городу.

**Списки проектов:** на страницах «Проекты» и в блоке проектов на главной у каждой карточки отображается **категория** (перевод по `category.{slug}`); категория — кликабельная ссылка на страницу проектов этой категории (`/projects/{categorySlug}` с учётом города).

**Файлы:** `lib/search-data.ts`, `app/api/pros/route.ts`, страницы `projects/[category]`, `contractors/[category]`, главная `app/[country]/[lang]/page.tsx`, отдельные страницы списков `projects/page.tsx`, `contractors/page.tsx` и их варианты с городом в `[city]/projects/page.tsx`, `[city]/contractors/page.tsx`.

---

## 7. URL, локали, город

- **Порядок сегментов:** страна → [язык, если не дефолтный] → путь. Город в URL только в конце пути для проектов/мастеров: `/pl/ru/projects/cleaning/warsaw`, `/pl/ru/contractors/cleaning/warsaw`. Главная с городом: `/pl/ru/warsaw` (один сегмент города после языка).
- **Дефолтный язык:** первый в `contentLocales` страны (`lib/countries.ts`). Для дефолтного языка в URL один сегмент страны (`/pl/...`), для остальных — два (`/pl/en/...`).
- **Город:** передаётся через middleware (x-city). Выбор города в хедере; при выборе города редирект на URL с городом (например главная → `/pl/ru/warsaw`). Списки проектов и мастеров на главной фильтруются по выбранному городу.
- Подробнее: `docs/urls-and-seo.md`.

---

## 8. Хлебные крошки и разметка (SEO)

- На всех шаблонах — хлебные крошки: навигация `<nav aria-label="Breadcrumb">` и JSON-LD `BreadcrumbList`. Опционально для страницы — сущность с `isPartOf` (WebSite или CollectionPage).
- **Типы страниц:** WebPage (обычные), CollectionPage (списки проектов/мастеров по категории). Списки дополнительно размечаются через `ItemList`; карточки — через типы сущностей (Demand для проектов, Person для мастеров).
- **Корневой объект:** WebSite с `@id` в корневом layout; страницы ссылаются на него через `isPartOf`.
- **Файлы:** `components/Breadcrumbs.tsx`, разметка в `ProjectsByCategoryContent`, `ContractorsByCategoryContent`, `ContractorProfileContent`, `FeedOffers`, `FeedMasters`, `app/layout.tsx`.

---

## 9. Страницы и маршруты (логика доступа)

| Путь | Доступ | Примечание |
|------|--------|------------|
| `/` | Публичный | Лендинг: выбор языка в шапке, карточки стран (клик → страна в текущем языке) |
| `/[country]/[lang]` | Публичный | Главная страны: две колонки (проекты и мастера по стране/городу), поиск, категории, блок «Почему commo.cc» |
| `/[country]/[lang]/[city]` | Публичный | Главная с выбранным городом; списки проектов и мастеров отфильтрованы по городу |
| `/[country]/[lang]/projects/[category]` | Публичный | Список проектов по категории (город из x-city) |
| `/[country]/[lang]/projects/[category]/[city]` | Публичный | Список проектов по категории и городу |
| `/[country]/[lang]/contractors/[category]` | Публичный | Список верифицированных мастеров по категории |
| `/[country]/[lang]/contractors/[category]/[city]` | Публичный | Список мастеров по категории и городу |
| `/[country]/[lang]/contractor/[id]` | Публичный | Профиль мастера (slug) |
| `/[country]/[lang]/signin` | Публичный | Вход через Google, опционально callbackUrl |
| `/[country]/[lang]/my-projects` | Только авторизованные | Редирект на signin с callbackUrl при отсутствии сессии |
| `/[country]/[lang]/pro` | Только авторизованные | Кабинет мастера: заглушка верификации или список профилей |
| `/[country]/[lang]/settings` | Публичный | Страна, языки общения |

**Навигация в шапке:** «Проекты» и «Мастера» ведут на главную с якорями `#home-projects` и `#home-contractors`. Выбор страны (CountrySelect), языка (LanguageDropdown), города (CitySelect). Меню пользователя: «My Projects», «As master», «Settings», «Sign out».

---

## 10. База данных (кратко)

- **users:** id, google_id (уникальный), email, name, country_code, client_rating, created_at. Поле role опционально (для совместимости с сидом).
- **projects:** client_id → users.id, страна, город, категория, title, description, status.
- **pro_profiles:** user_id → users.id, категория, рейтинг, языки (JSON), verified, bio, plan; города — в pro_profile_cities.
- Подробнее: `docs/database.md`.

---

## 11. Связь с другими документами

- **Правила проекта, контекст продукта:** `docs/project-rules.md`
- **URL и SEO:** `docs/urls-and-seo.md`
- **Схема БД и API:** `docs/database.md`
- **OAuth Google:** `docs/oauth-google-setup.md`
- **Оглавление документации:** `docs/README.md`

При изменении правил ролей, верификации, авторизации, поиска или разметки — обновлять этот файл и при необходимости смежные документы.
